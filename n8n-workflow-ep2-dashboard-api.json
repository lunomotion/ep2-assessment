{
  "name": "EP2 Dashboard API & Email Automation",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "ep2-dashboard-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "webhook-dashboard",
      "name": "Dashboard Data Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [220, 300],
      "webhookId": "ep2-dashboard-data"
    },
    {
      "parameters": {
        "url": "=https://api.typeform.com/forms/Xdi8cPPQ/responses?page_size=100",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "fetch-typeform",
      "name": "Fetch Typeform Responses",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "typeform-api",
          "name": "Typeform API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process Typeform responses for dashboard\nconst responses = $input.first().json.items || [];\n\nconst submissions = responses.map(response => {\n  const answers = response.answers || [];\n  const variables = response.variables || [];\n  const hidden = response.hidden || {};\n  \n  // Extract name\n  let name = hidden.name || 'Anonymous';\n  for (const answer of answers) {\n    if (answer.field?.title?.toLowerCase().includes('name') && answer.text) {\n      name = answer.text;\n      break;\n    }\n  }\n  \n  // Extract email\n  let email = hidden.email || null;\n  for (const answer of answers) {\n    if (answer.type === 'email') {\n      email = answer.email;\n      break;\n    }\n  }\n  \n  // Extract personality from variables or answers\n  let personality = 'Unknown';\n  for (const v of variables) {\n    const key = (v.key || '').toLowerCase();\n    if (key.includes('personality') || key.includes('animal') || key.includes('type') || key.includes('result')) {\n      const val = String(v.text || v.number || '').toLowerCase();\n      if (val.includes('wolf')) personality = 'Wolf';\n      else if (val.includes('tiger')) personality = 'Tiger';\n      else if (val.includes('whale')) personality = 'Whale';\n      else if (val.includes('lion')) personality = 'Lion';\n      break;\n    }\n  }\n  \n  // If no personality in variables, check for score-based determination\n  if (personality === 'Unknown') {\n    const scores = {};\n    for (const v of variables) {\n      const key = (v.key || '').toLowerCase();\n      if (key.includes('wolf')) scores.wolf = v.number || 0;\n      if (key.includes('tiger')) scores.tiger = v.number || 0;\n      if (key.includes('whale')) scores.whale = v.number || 0;\n      if (key.includes('lion')) scores.lion = v.number || 0;\n    }\n    if (Object.keys(scores).length > 0) {\n      const max = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];\n      if (max) personality = max[0].charAt(0).toUpperCase() + max[0].slice(1);\n    }\n  }\n  \n  // Extract risk level\n  let risk = 'Medium';\n  for (const v of variables) {\n    const key = (v.key || '').toLowerCase();\n    if (key.includes('risk')) {\n      const val = v.number || 0;\n      if (val >= 7) risk = 'High';\n      else if (val <= 3) risk = 'Low';\n      else risk = 'Medium';\n      break;\n    }\n  }\n  \n  // Extract reward level\n  let reward = 'Medium';\n  for (const v of variables) {\n    const key = (v.key || '').toLowerCase();\n    if (key.includes('reward')) {\n      const val = v.number || 0;\n      if (val >= 7) reward = 'High';\n      else if (val <= 3) reward = 'Low';\n      else reward = 'Medium';\n      break;\n    }\n  }\n  \n  // Calculate completion time\n  let completionTime = null;\n  if (response.landed_at && response.submitted_at) {\n    const diff = new Date(response.submitted_at) - new Date(response.landed_at);\n    const mins = Math.floor(diff / 60000);\n    const secs = Math.floor((diff % 60000) / 1000);\n    completionTime = `${mins}:${String(secs).padStart(2, '0')}`;\n  }\n  \n  return {\n    id: response.response_id || response.token,\n    name,\n    email,\n    personality,\n    risk,\n    reward,\n    completionTime,\n    submittedAt: response.submitted_at,\n    industries: ['General']\n  };\n});\n\n// Calculate stats\nconst total = submissions.length;\nconst thisWeek = submissions.filter(s => {\n  const weekAgo = new Date();\n  weekAgo.setDate(weekAgo.getDate() - 7);\n  return new Date(s.submittedAt) >= weekAgo;\n}).length;\n\n// Personality counts\nconst personalityCounts = { Wolf: 0, Tiger: 0, Whale: 0, Lion: 0 };\nconst riskCounts = { High: 0, Medium: 0, Low: 0 };\nconst rewardCounts = { High: 0, Medium: 0, Low: 0 };\n\nsubmissions.forEach(s => {\n  if (personalityCounts.hasOwnProperty(s.personality)) personalityCounts[s.personality]++;\n  if (riskCounts.hasOwnProperty(s.risk)) riskCounts[s.risk]++;\n  if (rewardCounts.hasOwnProperty(s.reward)) rewardCounts[s.reward]++;\n});\n\nconst safePercent = (count) => total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';\nconst safePercentInt = (count) => total > 0 ? Math.round((count / total) * 100) : 0;\n\n// Weekly trends (last 7 days)\nconst weeklyTrends = [0, 0, 0, 0, 0, 0, 0];\nconst now = new Date();\nsubmissions.forEach(s => {\n  const subDate = new Date(s.submittedAt);\n  const daysAgo = Math.floor((now - subDate) / 86400000);\n  if (daysAgo >= 0 && daysAgo < 7) {\n    weeklyTrends[6 - daysAgo]++;\n  }\n});\n\n// Completion times for avg\nconst times = submissions.filter(s => s.completionTime).map(s => {\n  const [m, sec] = s.completionTime.split(':').map(Number);\n  return m * 60 + sec;\n});\nconst avgSecs = times.length > 0 ? times.reduce((a, b) => a + b, 0) / times.length : 0;\nconst avgMins = Math.floor(avgSecs / 60);\nconst avgSecsRem = Math.floor(avgSecs % 60);\n\nreturn [{\n  json: {\n    submissions,\n    stats: {\n      totalSubmissions: total,\n      completionRate: 100,\n      avgCompletionTime: `${avgMins}:${String(avgSecsRem).padStart(2, '0')}`,\n      thisWeek,\n      changes: { thisWeek: 0, submissions: 0 }\n    },\n    personalities: {\n      wolf: { count: personalityCounts.Wolf, percent: safePercent(personalityCounts.Wolf) },\n      tiger: { count: personalityCounts.Tiger, percent: safePercent(personalityCounts.Tiger) },\n      whale: { count: personalityCounts.Whale, percent: safePercent(personalityCounts.Whale) },\n      lion: { count: personalityCounts.Lion, percent: safePercent(personalityCounts.Lion) }\n    },\n    riskDistribution: {\n      high: safePercentInt(riskCounts.High),\n      medium: safePercentInt(riskCounts.Medium),\n      low: safePercentInt(riskCounts.Low)\n    },\n    rewardDistribution: {\n      high: safePercentInt(rewardCounts.High),\n      medium: safePercentInt(rewardCounts.Medium),\n      low: safePercentInt(rewardCounts.Low)\n    },\n    industryPreferences: { General: total },\n    weeklyTrends,\n    lastUpdated: new Date().toISOString()\n  }\n}];"
      },
      "id": "process-data",
      "name": "Process Dashboard Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 300]
    },
    {
      "parameters": {
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "respond-webhook",
      "name": "Respond to Dashboard",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 300]
    },
    {
      "parameters": {
        "formId": "Xdi8cPPQ"
      },
      "id": "typeform-trigger",
      "name": "New Submission Trigger",
      "type": "n8n-nodes-base.typeformTrigger",
      "typeVersion": 1,
      "position": [220, 560],
      "webhookId": "ep2-typeform-trigger",
      "credentials": {
        "typeformApi": {
          "id": "typeform-creds",
          "name": "Typeform API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract personality, risk, reward from new submission\nconst data = $input.first().json;\nconst answers = data.answers || [];\nconst variables = data.variables || [];\nconst hidden = data.hidden || {};\n\n// Extract name\nlet name = hidden.name || 'Friend';\nfor (const answer of answers) {\n  if (answer.field?.title?.toLowerCase().includes('name') && answer.text) {\n    name = answer.text;\n    break;\n  }\n}\nconst firstName = name.split(' ')[0];\n\n// Extract email\nlet email = hidden.email || null;\nfor (const answer of answers) {\n  if (answer.type === 'email') {\n    email = answer.email;\n    break;\n  }\n}\n\n// Extract personality\nlet personality = 'Unknown';\nfor (const v of variables) {\n  const key = (v.key || '').toLowerCase();\n  if (key.includes('personality') || key.includes('animal') || key.includes('type') || key.includes('result')) {\n    const val = String(v.text || v.number || '').toLowerCase();\n    if (val.includes('wolf')) personality = 'Wolf';\n    else if (val.includes('tiger')) personality = 'Tiger';\n    else if (val.includes('whale')) personality = 'Whale';\n    else if (val.includes('lion')) personality = 'Lion';\n    break;\n  }\n}\n\n// Score-based fallback\nif (personality === 'Unknown') {\n  const scores = {};\n  for (const v of variables) {\n    const key = (v.key || '').toLowerCase();\n    if (key.includes('wolf')) scores.wolf = v.number || 0;\n    if (key.includes('tiger')) scores.tiger = v.number || 0;\n    if (key.includes('whale')) scores.whale = v.number || 0;\n    if (key.includes('lion')) scores.lion = v.number || 0;\n  }\n  if (Object.keys(scores).length > 0) {\n    const max = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];\n    if (max) personality = max[0].charAt(0).toUpperCase() + max[0].slice(1);\n  }\n}\n\n// Extract risk\nlet risk = 'Medium';\nlet riskScore = 5;\nfor (const v of variables) {\n  const key = (v.key || '').toLowerCase();\n  if (key.includes('risk')) {\n    riskScore = v.number || 5;\n    if (riskScore >= 7) risk = 'High';\n    else if (riskScore <= 3) risk = 'Low';\n    break;\n  }\n}\n\n// Extract reward\nlet reward = 'Medium';\nlet rewardScore = 5;\nfor (const v of variables) {\n  const key = (v.key || '').toLowerCase();\n  if (key.includes('reward')) {\n    rewardScore = v.number || 5;\n    if (rewardScore >= 7) reward = 'High';\n    else if (rewardScore <= 3) reward = 'Low';\n    break;\n  }\n}\n\n// Personality descriptions\nconst descriptions = {\n  Wolf: {\n    emoji: 'ðŸº',\n    title: 'The Strategic Wolf',\n    traits: 'strategic, independent, and analytical',\n    strengths: 'Your methodical approach and keen analytical skills make you excellent at spotting opportunities others miss. You thrive when you can work independently and make data-driven decisions.',\n    industries: 'consulting, finance, or strategic advisory roles'\n  },\n  Tiger: {\n    emoji: 'ðŸ…',\n    title: 'The Bold Tiger',\n    traits: 'bold, driven, and competitive',\n    strengths: 'Your natural drive and competitive spirit position you perfectly for high-growth opportunities. You excel in fast-paced environments where quick decisions matter.',\n    industries: 'tech startups, venture-backed companies, or high-growth sectors'\n  },\n  Whale: {\n    emoji: 'ðŸ‹',\n    title: 'The Steady Whale',\n    traits: 'steady, patient, and focused on long-term success',\n    strengths: 'Your patience and focus on sustainable growth make you ideal for building lasting enterprises. You excel at nurturing relationships and creating stable foundations.',\n    industries: 'healthcare, education, or established franchise models'\n  },\n  Lion: {\n    emoji: 'ðŸ¦',\n    title: 'The Natural Leader Lion',\n    traits: 'a natural leader who is confident and decisive',\n    strengths: 'Your leadership abilities and confident decision-making style make you perfect for roles where you can inspire and guide others toward a shared vision.',\n    industries: 'management positions, team-based ventures, or executive leadership'\n  }\n};\n\nconst desc = descriptions[personality] || descriptions.Tiger;\n\nreturn [{\n  json: {\n    email,\n    firstName,\n    fullName: name,\n    personality,\n    risk,\n    reward,\n    riskScore,\n    rewardScore,\n    ...desc,\n    responseId: data.response_id || data.token\n  }\n}];"
      },
      "id": "extract-results",
      "name": "Extract Assessment Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 560]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-email",
              "leftValue": "={{ $json.email }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-email",
      "name": "Has Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, 560]
    },
    {
      "parameters": {
        "fromEmail": "={{ $env.SMTP_FROM_EMAIL || 'hello@praxiainsights.com' }}",
        "toEmail": "={{ $json.email }}",
        "subject": "=Your EP2 Assessment Results - {{ $json.title }}",
        "emailType": "html",
        "html": "=<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #1a1a1a; max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { text-align: center; padding: 30px 0; }\n    .emoji { font-size: 64px; }\n    h1 { color: #6366f1; margin: 20px 0 10px; }\n    .subtitle { color: #6b6b6b; font-size: 18px; }\n    .card { background: #f8f7f5; border-radius: 12px; padding: 24px; margin: 24px 0; }\n    .card h2 { margin-top: 0; color: #1a1a1a; }\n    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 500; margin: 4px; }\n    .badge-high { background: #fef2f2; color: #dc2626; }\n    .badge-medium { background: #fefce8; color: #ca8a04; }\n    .badge-low { background: #f0fdf4; color: #16a34a; }\n    .cta { display: inline-block; background: #6366f1; color: white; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 500; margin: 20px 0; }\n    .footer { text-align: center; color: #6b6b6b; font-size: 14px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e8e4df; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"emoji\">{{ $json.emoji }}</div>\n    <h1>{{ $json.title }}</h1>\n    <p class=\"subtitle\">Hi {{ $json.firstName }}, congratulations on completing your EP2 Assessment!</p>\n  </div>\n  \n  <div class=\"card\">\n    <h2>Your Profile</h2>\n    <p>Based on your responses, you are <strong>{{ $json.traits }}</strong>.</p>\n    <p>{{ $json.strengths }}</p>\n  </div>\n  \n  <div class=\"card\">\n    <h2>Your Risk & Reward Profile</h2>\n    <p>\n      <strong>Risk Tolerance:</strong> <span class=\"badge badge-{{ $json.risk.toLowerCase() }}\">{{ $json.risk }}</span><br>\n      <strong>Reward Orientation:</strong> <span class=\"badge badge-{{ $json.reward.toLowerCase() }}\">{{ $json.reward }}</span>\n    </p>\n    <p>This combination suggests you may thrive in {{ $json.industries }}.</p>\n  </div>\n  \n  <div style=\"text-align: center;\">\n    <p>Ready to explore opportunities that match your unique profile?</p>\n    <a href=\"https://praxiainsights.com/consultation\" class=\"cta\">Schedule a Consultation</a>\n  </div>\n  \n  <div class=\"footer\">\n    <p>Questions about your results? Just reply to this email.</p>\n    <p>Â© EP2 Assessment by Praxia Insights</p>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Results Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [880, 480],
      "credentials": {
        "smtp": {
          "id": "smtp-creds",
          "name": "SMTP"
        }
      }
    },
    {
      "parameters": {},
      "id": "no-email",
      "name": "No Email - Skip",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [880, 640]
    }
  ],
  "connections": {
    "Dashboard Data Webhook": {
      "main": [
        [
          {
            "node": "Fetch Typeform Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Typeform Responses": {
      "main": [
        [
          {
            "node": "Process Dashboard Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Dashboard Data": {
      "main": [
        [
          {
            "node": "Respond to Dashboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "New Submission Trigger": {
      "main": [
        [
          {
            "node": "Extract Assessment Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Assessment Results": {
      "main": [
        [
          {
            "node": "Has Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Email?": {
      "main": [
        [
          {
            "node": "Send Results Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Email - Skip",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "pinData": {}
}
